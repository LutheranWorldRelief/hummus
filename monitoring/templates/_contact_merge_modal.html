{% load static %}
{% load i18n %}
<div id="modal-merge" class="fade modal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
{% verbatim %}
<h4>FUSIONANDO / {{name}}</h4>
{% endverbatim %}
</div>
<div class="modal-body">
    <div v-if="loading.modal">
        <img style="margin:0 auto; display: block" src="{% static 'img/loading.gif' %}" alt="">
        <div class="callout callout-warning" v-if="loading.fusion">
	    <h4>{% trans 'Fusionando Registros de Contacto...' %}</h4>
        </div>
    </div>
    <div v-if="!loading.modal && models.length > 0">
        <!-- ---------------------------------------------------------------------------- SELECT -->
        <div v-if="modalState=='select'">
            <div class="callout callout-danger" v-cloak v-if="models.length <= 1">
		<h4>{% trans 'No es posible fusionar solo un registro' %}</h4>
            </div>
            <div class="callout callout-info" v-cloak v-if="models.length > 1">
		<h4>{% trans 'Seleccione el registro que se usará como principal' %}</h4>
            </div>
            {% verbatim %}
            <table class="table">
                <tr v-for="(model, index) in models">
                    <td><input type="radio" :value="model.id" v-model="modelSelected"></td>
                    <td>{{index+1}}</td>
                    <td>{{model.id}}</td>
                    <td><a :href="'/contact/' + model.id" target="_blank">{{model.name}}</a>
                    </td>
                    <td>{{model.document}}</td>
                    <td>{{list_countries[model.country]}}</td>
                    <td>
                        <button type="button" class="btn btn-xs btn-primary pull-right"
                                v-if="models.length > 1"
                                @click="fusionExclude(model, index)">
                            Excluir
                        </button>
                    </td>
                </tr>
            </table>
            {% endverbatim %}
        </div>

        <!-- ---------------------------------------------------------------------------- RESOLVE -->
        <div v-if="modalState=='resolve'">
            <div class="callout callout-info" v-if="Object.keys(modelsResolve).length > 0">
		<h4>{% trans 'Debe seleccionar una opción de los siguientes campos para establecerlo en el registro final' %}</h4>
            </div>
            {% verbatim %}
            <table class="table" style="display: block; overflow-y: scroll; max-height: 500px;">
                <tr v-for="(values, key) in modelsResolve" v-if="showAttribute(key)">
                    <th>{{ modelLabels[key] }}</th>
                    <td>
                        <select class="form-control" v-model="modelMerge[key]" v-if="showField(key)">
                            <option v-for="value in values">{{ value }}</option>
                        </select>
                        <select class="form-control" v-model="modelMerge[key]" v-if="'country' == key">
                            <option v-for="value in values" :value="value">{{ list_countries[value] }}</option>
                        </select>
                        <select class="form-control" v-model="modelMerge[key]" v-if="'organization_id' == key">
                            <option v-for="value in values" :value="value">{{ list_organizations[value] }}</option>
                        </select>
                        <select class="form-control" v-model="modelMerge[key]" v-if="'type_id' == key">
                            <option v-for="value in values" :value="value">{{ list_types[value] }}</option>
                        </select>
                        <select class="form-control" v-model="modelMerge[key]" v-if="'education_id' == key">
                            <option v-for="value in values" :value="value">{{ list_education[value] }}</option>
                        </select>
                    </td>
                </tr>
            </table>
            {% endverbatim %}
            <div class="callout callout-info" v-if="modelsResolve.length == 0">
		<h4>{% trans 'No hay datos que resolver. Por favor presione el botón "Resuelto" para pasar al siguiente paso.' %}</h4>
            </div>
        </div>

        <!-- ---------------------------------------------------------------------------- FUSION -->
        <div v-if="modalState=='fusion'">
            <div class="callout callout-danger" v-if="errorFlags.fusion">
		<h4>{% trans 'No fue posible fusionar el registro. Vuelva a Intentarlo' %}</h4>
		<h5>{% trans 'Si el problema persiste, contacte al desarrollador del sistema' %}</h5>
            </div>
            <div class="callout callout-info" v-if="!loading.fusion && !errorFlags.fusion">
		<h4>{% trans 'Se comenzará el proceso al presionar el botón "Fusionar"' %}</h4>
            </div>
        </div>

        <!-- ---------------------------------------------------------------------------- FINISH -->
        <div v-if="modalState=='finish'">
            <div class="callout callout-danger" v-if="errorFlags.finish">
		<h4>{% trans 'El proceso de fusión ha terminado pero con errores.' %}</h4>
		<h5>{% trans 'Por favor contacte al desarrollador del sistema e indique la siguiente información' %}</h5>
        {{ verbatim }}
                <pre>{{errorMessage.finish}}</pre>
        {{ endverbatim }}
            </div>
            <div class="callout callout-info" v-if="!errorFlags.finish">
		<h4>{% trans 'Se ha finalizado el proceso de fusión. Presione Finalizar para recargar los datos de usuarios.' %}</h4>
            </div>
            <!--
            <button class="btn btn-sm btn-info" @click="fusionFlags.result = !fusionFlags.result">
                <span v-if="!fusionFlags.result">Ver</span>
                <span v-if="fusionFlags.result">Ocultar</span> resultado
            </button>
            <br>
        {{ verbatim }}
            <pre v-if="fusionFlags.result">{{fusionResult}}</pre>
        {{ endverbatim }}
            -->
        </div>
        <hr>
        <!-- ---------------------------------------------------------------------------- BUTTONS -->
        <button type="button" class="btn btn-large btn-danger" v-if="!loading.modal"
                @click="fusionCancelar('#modal-merge')">
            <span v-if="modalState != 'finish'">
                <i class="fa fa-ban"></i> Cancelar
            </span>
            <span v-if="modalState == 'finish'">
                <i class="fa fa-times"></i> Cerrar
            </span>
        </button>


        <button type="button" class="btn btn-large btn-primary pull-right"
                @click="fusionSelect"
                v-if="models.length > 1 && modalState == 'select' && modelSelected">
            <i class="fa fa-check"></i> Seleccionar
        </button>
        <button type="button" class="btn btn-large btn-primary pull-right"
                @click="fusionResolve"
                v-if="models.length > 1 && modalState == 'resolve'">
            <i class="fa fa-check"></i> Resuelto
        </button>
        <button type="button" class="btn btn-large btn-warning pull-right"
                @click="fusionStart"
                v-if="models.length > 1 && modalState == 'fusion'">
            <i class="fa fa-hand-o-right"></i> Fusionar
        </button>

        <button type="button" class="btn btn-large btn-primary pull-right"
                v-if="models.length > 1 && modalState == 'finish'"
                @click="fusionFinish"
                data-toggle="modal"
                data-target="#modal-merge">
            <i class="fa fa-check"></i> Finalizar
        </button>

        <a class="btn btn-large btn-primary pull-right"
           v-if="models.length > 1 && modalState == 'finish'"
           target="_blank"
           :href="'/contact/' + modelSelected">{% trans 'Ver Registro Fusionado' %}></a>
    </div>
</div>
</div>
</div></div>
